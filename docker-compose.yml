services:
  prepare_manifest:
    build:
      context: .
      dockerfile: docker/manifest/Dockerfile
    environment:
      - PYTHONPATH=/workspace
    volumes:
      - ./input:/workspace/input
      - ./output:/workspace/output
      - ./data:/workspace/data
      - ./scripts:/workspace/scripts
      - ./src:/workspace/src
    working_dir: /workspace
    restart: "no"
    command:
      - python
      - /workspace/scripts/prepare_manifest.py
      - --in_json
      - /workspace/input/substations.json
      - --out_csv
      - /workspace/data/manifests/substations_manifest.csv

  qgis_smoke:
    profiles: ["debug"]
    build:
      context: .
      dockerfile: docker/qgis/Dockerfile
    environment:
      - QT_QPA_PLATFORM=offscreen
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      - HOME=/tmp
    volumes:
      - ./data:/workspace/data
      - ./output:/workspace/output
      - ./configs:/workspace/configs
    working_dir: /workspace
    command:
      - python3
      - /workspace/configs/qgis_smoke_test.py
      - --project
      - /workspace/data/qgis/image_snapshots_latest.qgz
      - --expect_layer
      - Google Satellite
      - --test_render_out
      - /workspace/output/_smoke_render.png

  osm_fetch:
    build:
      context: .
      dockerfile: docker/qgis/Dockerfile
    environment:
      - OVERPASS_URLS=${OVERPASS_URLS:-https://overpass.kumi.systems/api/interpreter,https://overpass.private.coffee/api/interpreter,https://overpass.openstreetmap.ru/api/interpreter,https://overpass-api.de/api/interpreter}
      - REQUEST_TIMEOUT_SEC=${REQUEST_TIMEOUT_SEC:-60}
      - PYTHONPATH=/workspace
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/workspace/data
      - ./configs:/workspace/configs
      - ./src:/workspace/src
      - ./output:/workspace/output
    working_dir: /workspace
    restart: "no"
    depends_on:
      prepare_manifest:
        condition: service_completed_successfully
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        test -f /workspace/data/manifests/substations_manifest.csv || \
          (echo "‚ùå Missing /workspace/data/manifests/substations_manifest.csv" && exit 1)

        mkdir -p /workspace/data/footprints

        # Check existing footprints status
        EXISTING_COUNT=0
        if [ -f /workspace/data/footprints/footprints.csv ]; then
          EXISTING_COUNT=$$(tail -n +2 /workspace/data/footprints/footprints.csv | wc -l | tr -d ' ')
          echo "üìÇ Found existing footprints.csv with $$EXISTING_COUNT entries"
        fi

        TOTAL_COUNT=$$(tail -n +2 /workspace/data/manifests/substations_manifest.csv | wc -l | tr -d ' ')
        
        if [ "$$EXISTING_COUNT" -eq "$$TOTAL_COUNT" ] && [ "$$EXISTING_COUNT" -gt 0 ]; then
          echo "‚úÖ All $$TOTAL_COUNT substations already have footprints - skipping fetch"
          exit 0
        fi

        echo "üåç Fetching OSM footprints..."
        
        if [ "$$EXISTING_COUNT" -gt 0 ]; then
          NEW_NEEDED=$$((TOTAL_COUNT - EXISTING_COUNT))
          echo "üìä Status: Have $$EXISTING_COUNT/$$TOTAL_COUNT footprints"
          echo "   Need to fetch: ~$$NEW_NEEDED new substations"
          echo "   Note: Actual new fetches depend on OSM ID overlap"
        else
          echo "üìä Fetching all $$TOTAL_COUNT substations (no existing footprints)"
        fi
        
        echo "‚ÑπÔ∏è  Process features:"
        echo "   ‚Ä¢ Will reuse existing footprints (no re-fetching)"
        echo "   ‚Ä¢ Resume from cache if interrupted"
        echo "   ‚Ä¢ Try multiple servers if needed"
        
        # Run the fetch with resume - it will skip already fetched substations
        python3 /workspace/configs/osm_fetch_footprints.py \
          --mapping_csv /workspace/data/manifests/substations_manifest.csv \
          --out_dir /workspace/data/footprints \
          --radius_m 600 \
          --fail_soft \
          --request_timeout_sec $${REQUEST_TIMEOUT_SEC:-60} \
          --retries 3 \
          --resume \
          --require_found || OSM_EXIT_CODE=$$?
        
        # Check final results
        if [ -f /workspace/data/footprints/footprints.csv ]; then
          FINAL_COUNT=$$(tail -n +2 /workspace/data/footprints/footprints.csv | wc -l | tr -d ' ')
          NEW_FETCHED=$$((FINAL_COUNT - EXISTING_COUNT))
          
          if [ "$$FINAL_COUNT" -gt 0 ]; then
            echo "‚úÖ Footprints ready: $$FINAL_COUNT/$$TOTAL_COUNT"
            
            if [ "$$NEW_FETCHED" -gt 0 ]; then
              echo "   ‚Ä¢ Reused: $$EXISTING_COUNT existing footprints"
              echo "   ‚Ä¢ Fetched: $$NEW_FETCHED new footprints"
            else
              echo "   ‚Ä¢ All footprints were already cached"
            fi
            
            if [ "$$FINAL_COUNT" -lt "$$TOTAL_COUNT" ]; then
              MISSING=$$((TOTAL_COUNT - FINAL_COUNT))
              echo "‚ÑπÔ∏è  Missing $$MISSING footprints - will use buffer-based snapshots for those"
            fi
          else
            echo "‚ö†Ô∏è No footprints found - all substations will use buffer-based snapshots"
            printf "osm_id,footprint_wkt,found,method,note,estimated_size_m,Latitude,Longitude,Name,Voltages\n" > /workspace/data/footprints/footprints.csv
          fi
        else
          echo "‚ö†Ô∏è OSM fetch failed - creating empty footprints.csv"
          printf "osm_id,footprint_wkt,found,method,note,estimated_size_m,Latitude,Longitude,Name,Voltages\n" > /workspace/data/footprints/footprints.csv
        fi
        
        # Report cache status
        if [ -f /workspace/data/footprints/footprint_cache.json ]; then
          CACHE_SIZE=$$(python3 -c "import json; print(len(json.load(open('/workspace/data/footprints/footprint_cache.json'))))" 2>/dev/null || echo "0")
          echo "üíæ Cache updated: $$CACHE_SIZE total entries saved for next run"
        fi

  qgis_snapshots:
    build:
      context: .
      dockerfile: docker/qgis/Dockerfile
    environment:
      - QT_QPA_PLATFORM=offscreen
      - QT_OPENGL=software
      - LIBGL_ALWAYS_SOFTWARE=1
      - XDG_RUNTIME_DIR=/tmp/runtime-root
      - HOME=/tmp
      - PYTHONPATH=/workspace
    volumes:
      - ./data:/workspace/data
      - ./output:/workspace/output
      - ./configs:/workspace/configs
      - ./src:/workspace/src
    working_dir: /workspace
    restart: "no"
    depends_on:
      osm_fetch:
        condition: service_completed_successfully
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        test -f /workspace/data/manifests/substations_manifest.csv || \
          (echo "‚ùå Missing manifest. Run: docker compose --profile tools run --rm prepare_manifest" && exit 1)

        mkdir -p /workspace/data/snapshots

        if test -f /workspace/data/footprints/footprints.csv && [ "$(wc -l < /workspace/data/footprints/footprints.csv)" -gt 1 ]; then
          echo "‚úÖ Using footprints extent"
          python3 /workspace/configs/regenerate_highres_headless.py \
            --project /workspace/data/qgis/image_snapshots_latest.qgz \
            --mapping_csv /workspace/data/manifests/substations_manifest.csv \
            --output_dir /workspace/data/snapshots \
            --wms_layer_name "Google Satellite" \
            --buffer_m 300 \
            --img_size_px 1024 \
            --dpi 300 \
            --csv_filename image_meters_per_px.csv \
            --footprints_csv /workspace/data/footprints/footprints.csv \
            --use_footprint_extent \
            --footprint_pad_m 50 \
            --context_pad_m 100 \
            --min_extent_m 600 \
            --skip_existing
        else
          echo "‚ö†Ô∏è Footprints missing/empty ‚Üí fallback to buffer-based snapshots"
          python3 /workspace/configs/regenerate_highres_headless.py \
            --project /workspace/data/qgis/image_snapshots_latest.qgz \
            --mapping_csv /workspace/data/manifests/substations_manifest.csv \
            --output_dir /workspace/data/snapshots \
            --wms_layer_name "Google Satellite" \
            --buffer_m 300 \
            --img_size_px 1024 \
            --dpi 300 \
            --csv_filename image_meters_per_px.csv \
            --skip_existing
        fi

        # No copying - snapshots stay in data/ only
        echo "‚úÖ Snapshots generated in data/snapshots/"

  unet_infer:
    build:
      context: .
      dockerfile: docker/unet/Dockerfile
    environment:
      - PYTHONPATH=/workspace
      - TORCH_HOME=/workspace/data/.cache/torch
      - HF_HOME=/workspace/data/.cache/huggingface
      - PIPELINE_NO_IMAGES=${PIPELINE_NO_IMAGES:-false}
    volumes:
      - ./data:/workspace/data
      - ./output:/workspace/output
      - ./models:/workspace/models:ro
      - ./src:/workspace/src
      - ./scripts:/workspace/scripts
    working_dir: /workspace
    restart: "no"
    depends_on:
      qgis_snapshots:
        condition: service_completed_successfully
    command:
      - bash
      - -c
      - |
        if [ "$${PIPELINE_NO_IMAGES:-false}" = "true" ]; then
          EXTRA_ARGS="--no_images"
        else
          EXTRA_ARGS=""
        fi
        python /workspace/scripts/run_unet_inference.py \
          --images_dir /workspace/data/snapshots \
          --output_dir /workspace/output/unet_results \
          --model_pth /workspace/models/unet.pth \
          --encoder_name resnet34 \
          --encoder_weights imagenet \
          --pattern "*.png" \
          --device auto \
          --allow_no_scale \
          --scale_manifest_csv /workspace/data/snapshots/image_meters_per_px.csv \
          --skip_existing \
          $${EXTRA_ARGS}

  capacity_infer:
    build:
      context: .
      dockerfile: docker/unet/Dockerfile
    environment:
      - PYTHONPATH=/workspace
    volumes:
      - ./data:/workspace/data
      - ./output:/workspace/output
      - ./models:/workspace/models:ro
      - ./src:/workspace/src
      - ./scripts:/workspace/scripts
    working_dir: /workspace
    restart: "no"
    depends_on:
      unet_infer:
        condition: service_completed_successfully
    command:
      - python
      - /workspace/scripts/run_capacity_inference.py
      - --unet_csv
      - /workspace/output/unet_results/transformer_detections.csv
      - --manifest_csv
      - /workspace/data/manifests/substations_manifest.csv
      - --model_joblib
      - /workspace/models/capacity_model.joblib
      - --model_config
      - /workspace/models/model_config.json
      - --out_csv
      - /workspace/output/capacity_results/transformers_with_capacity.csv
      - --summary_csv
      - /workspace/output/capacity_results/substations_capacity_summary.csv

  yolo_infer:
    build:
      context: .
      dockerfile: docker/yolo/Dockerfile
    environment:
      - PYTHONPATH=/workspace
      - YOLO_CONFIG_DIR=/tmp/Ultralytics
      - PIPELINE_NO_IMAGES=${PIPELINE_NO_IMAGES:-false}
    volumes:
      - ./data:/workspace/data
      - ./output:/workspace/output
      - ./models:/workspace/models:ro
      - ./src:/workspace/src
      - ./scripts:/workspace/scripts
    working_dir: /workspace
    restart: "no"
    depends_on:
      qgis_snapshots:
        condition: service_completed_successfully
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        mkdir -p /workspace/output/yolo_results
        
        if [ "$${PIPELINE_NO_IMAGES:-false}" = "true" ]; then
          EXTRA_ARGS="--no-images"
        else
          mkdir -p /workspace/output/yolo_results/annotated
          EXTRA_ARGS="--out_annotated_dir /workspace/output/yolo_results/annotated"
        fi
        
        python /workspace/scripts/run_yolo_inference.py \
          --images_dir /workspace/data/snapshots \
          --model_pt /workspace/models/yolo.pt \
          --out_csv /workspace/output/yolo_results/yolo_detections.csv \
          --summary_csv /workspace/output/yolo_results/yolo_summary.csv \
          --pattern "*.png" \
          --conf 0.25 \
          --iou 0.45 \
          --device cpu \
          --skip_existing \
          $${EXTRA_ARGS}

  score:
    build:
      context: .
      dockerfile: docker/score/Dockerfile
    environment:
      - PYTHONPATH=/workspace
    volumes:
      - ./data:/workspace/data
      - ./src:/workspace/src
      - ./scripts:/workspace/scripts
      - ./input:/workspace/input
      - ./output:/workspace/output
    working_dir: /workspace
    depends_on:
      capacity_infer:
        condition: service_completed_successfully
      yolo_infer:
        condition: service_completed_successfully
    command:
      - python
      - /workspace/scripts/run_substation_scoring.py
      - --manifest_csv
      - /workspace/data/manifests/substations_manifest.csv
      - --capacity_summary_csv
      - /workspace/output/capacity_results/substations_capacity_summary.csv
      - --unet_csv
      - /workspace/output/unet_results/transformer_detections.csv
      - --yolo_summary_csv
      - /workspace/output/yolo_results/yolo_summary.csv
      - --yolo_detections_csv
      - /workspace/output/yolo_results/yolo_detections.csv
      - --out_csv
      - /workspace/output/score_results/substations_scored.csv
